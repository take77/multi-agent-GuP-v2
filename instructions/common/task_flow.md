# Task Flow

## Workflow: Captain → Vice Captain → Member

```
Lord: command → Captain: write YAML → inbox_write → Vice Captain: decompose → inbox_write → Member: execute → report YAML → inbox_write → Vice Captain: update dashboard → Captain: read dashboard
```

## Immediate Delegation Principle (Captain)

**Delegate to Vice Captain immediately and end your turn** so the Lord can input next command.

```
Lord: command → Captain: write YAML → inbox_write → END TURN
                                        ↓
                                  Lord: can input next
                                        ↓
                              Vice Captain/Member: work in background
                                        ↓
                              dashboard.md updated as report
```

## Event-Driven Wait Pattern (Vice Captain)

**After dispatching all subtasks: STOP.** Do not launch background monitors or sleep loops.

```
Step 7: Dispatch cmd_N subtasks → inbox_write to member
Step 8: check_pending → if pending cmd_N+1, process it → then STOP
  → Vice Captain becomes idle (prompt waiting)
Step 9: Member completes → inbox_write vice_captain → watcher nudges vice_captain
  → Vice Captain wakes, scans reports, acts
```

**Why no background monitor**: inbox_watcher.sh detects member's inbox_write to vice_captain and sends a nudge. This is true event-driven. No sleep, no polling, no CPU waste.

**Vice Captain wakes via**: inbox nudge from member report, captain new cmd, or system event. Nothing else.

## "Wake = Full Scan" Pattern

Claude Code cannot "wait". Prompt-wait = stopped.

1. Dispatch member
2. Say "stopping here" and end processing
3. Member wakes you via inbox
4. Scan ALL report files (not just the reporting one)
5. Assess situation, then act

## Report Scanning (Communication Loss Safety)

On every wakeup (regardless of reason), scan ALL `queue/reports/member*_report.yaml`.
Cross-reference with dashboard.md — process any reports not yet reflected.

**Why**: Member inbox messages may be delayed. Report files are already written and scannable as a safety net.

## Foreground Block Prevention (24-min Freeze Lesson)

**Vice Captain blocking = entire army halts.** On 2026-02-06, foreground `sleep` during delivery checks froze vice_captain for 24 minutes.

**Rule: NEVER use `sleep` in foreground.** After dispatching tasks → stop and wait for inbox wakeup.

| Command Type | Execution Method | Reason |
|-------------|-----------------|--------|
| Read / Write / Edit | Foreground | Completes instantly |
| inbox_write.sh | Foreground | Completes instantly |
| `sleep N` | **FORBIDDEN** | Use inbox event-driven instead |
| tmux capture-pane | **FORBIDDEN** | Read report YAML instead |

### Dispatch-then-Stop Pattern

```
✅ Correct (event-driven):
  cmd_008 dispatch → inbox_write member → stop (await inbox wakeup)
  → member completes → inbox_write vice_captain → vice_captain wakes → process report

❌ Wrong (polling):
  cmd_008 dispatch → sleep 30 → capture-pane → check status → sleep 30 ...
```

## Timestamps

**Always use `date` command.** Never guess.
```bash
date "+%Y-%m-%d %H:%M"       # For dashboard.md
date "+%Y-%m-%dT%H:%M:%S"    # For YAML (ISO 8601)
```
