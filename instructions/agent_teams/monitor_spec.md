# å‚è¬€é•·ãƒ¢ãƒ‹ã‚¿ãƒ—ãƒ­ã‚»ã‚¹å‹•ä½œä»•æ§˜æ›¸

## 1. èµ·å‹•æ–¹æ³•

### èµ·å‹•ã‚³ãƒãƒ³ãƒ‰

```bash
cd scripts/monitor
node start.ts [OPTIONS]
```

### ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°

| ã‚ªãƒ—ã‚·ãƒ§ãƒ³ | èª¬æ˜ |
|-----------|------|
| `--dry-run` | dry-run ãƒ¢ãƒ¼ãƒ‰ã€‚è¨­å®šæ¤œè¨¼ã®ã¿è¡Œã„ã€Agent SDK ã® query() ã‚’å‘¼ã°ãšã«çµ‚äº† |

### ç’°å¢ƒå¤‰æ•°

| å¤‰æ•°å | å¿…é ˆ | èª¬æ˜ |
|--------|------|------|
| ï¼ˆãªã—ï¼‰ | - | ç¾åœ¨ã€ç’°å¢ƒå¤‰æ•°ã«ã‚ˆã‚‹è¨­å®šã¯æœªä½¿ç”¨ |

### ä¾å­˜ãƒ•ã‚¡ã‚¤ãƒ«

èµ·å‹•æ™‚ã«ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€:

1. **config/settings.yaml** (ç›¸å¯¾ãƒ‘ã‚¹: `../../config/settings.yaml`)
   - `agent_teams` ã‚»ã‚¯ã‚·ãƒ§ãƒ³å¿…é ˆ
   - `agent_teams.lead.agent_id`, `agent_teams.lead.model`, `agent_teams.lead.effort`, `agent_teams.lead.delegate_mode` ã‚’å‚ç…§
   - `agent_teams.monitor.state_file` ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’æŒ‡å®š
   - `agent_teams.teammates[]` ã§å”åŠ›ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆä¸€è¦§ã‚’å®šç¾©

2. **instructions/battalion_commander.md** (ç›¸å¯¾ãƒ‘ã‚¹: `../../instructions/battalion_commander.md`)
   - Lead ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã® system prompt ã¨ã—ã¦ä½¿ç”¨

3. **queue/hq/session_state.yaml** (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‘ã‚¹ã€settings.yaml ã§å¤‰æ›´å¯)
   - å¾©å¸°ãƒ¢ãƒ¼ãƒ‰æ™‚ã«æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’èª­ã¿è¾¼ã¿

### èµ·å‹•ã‚·ãƒ¼ã‚±ãƒ³ã‚¹

1. `--dry-run` ãƒ•ãƒ©ã‚°æ¤œå‡º
2. `config/settings.yaml` èª­ã¿è¾¼ã¿
3. `StateManager` åˆæœŸåŒ– + `session_state.yaml` èª­ã¿è¾¼ã¿ï¼ˆå­˜åœ¨ã—ãªã„å ´åˆã¯åˆæœŸçŠ¶æ…‹ï¼‰
4. `instructions/battalion_commander.md` èª­ã¿è¾¼ã¿
5. 4ã¤ã® hooks ç™»éŒ²
6. `--dry-run` æ™‚: è¨­å®šæ¤œè¨¼æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡ºåŠ›ã—ã¦çµ‚äº†ï¼ˆexit code 0ï¼‰
7. é€šå¸¸ãƒ¢ãƒ¼ãƒ‰æ™‚: `CostTracker` åˆæœŸåŒ–
8. Agent SDK å‹•çš„ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆå¤±æ•—æ™‚ã¯ npm install æŒ‡ç¤ºã‚’å‡ºã—ã¦ exit code 1ï¼‰
9. `query()` èµ·å‹•ï¼ˆmodel, effort, delegateMode, systemPrompt, prompt, hooks, onMessage ã‚’æŒ‡å®šï¼‰
10. ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†å¾Œ: `stateManager.save()` + `costTracker.writeTo()` ã§çŠ¶æ…‹ä¿å­˜

---

## 2. 4ã¤ã® Hooks ã®å‹•ä½œä»•æ§˜

### 2.1 TaskCompleted Hook

**ãƒˆãƒªã‚¬ãƒ¼**: ã‚¿ã‚¹ã‚¯å®Œäº†æ™‚ï¼ˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒã‚¿ã‚¹ã‚¯ã‚’å®Œäº†å ±å‘Šã—ãŸã¨ãï¼‰

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `scripts/monitor/hooks/task_completed.ts`

#### å‹•ä½œãƒ•ãƒ­ãƒ¼

1. å…¥åŠ›ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ `task_id` ã¨ `result` ã‚’å–å¾—
2. `task_id` ãŒæœªå®šç¾©ã®å ´åˆ â†’ **ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒ—ãƒ³**ï¼ˆ`{}` ã‚’è¿”ã—ã¦ã‚¿ã‚¹ã‚¯å®Œäº†ã‚’è¨±å¯ï¼‰
3. `StateManager` çµŒç”±ã§è©²å½“ã‚¿ã‚¹ã‚¯ã®å—å…¥åŸºæº–ï¼ˆacceptance criteriaï¼‰ã‚’å–å¾—
   - `queue/tasks/*.yaml` ã‹ã‚‰ `task.task_id` ãŒä¸€è‡´ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¢ç´¢
   - `task.acceptance_criteria` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¾ãŸã¯ `task.description` å†…ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹å½¢å¼ï¼ˆ`- [ ]`ï¼‰ã‚’æŠ½å‡º
4. å—å…¥åŸºæº–ãŒå­˜åœ¨ã—ãªã„å ´åˆ â†’ **ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒ—ãƒ³**ï¼ˆ`{}` ã‚’è¿”ã—ã¦ã‚¿ã‚¹ã‚¯å®Œäº†ã‚’è¨±å¯ï¼‰
5. å„å—å…¥åŸºæº–ã«å¯¾ã—ã¦æ¤œè¨¼:
   - `result` ãŒ undefined/null â†’ **ãƒ–ãƒ­ãƒƒã‚¯**ï¼ˆ`{ decision: "block", reason: "..." }` ã‚’è¿”ã™ï¼‰
   - `result` æ–‡å­—åˆ—ã«åŸºæº–ãŒå«ã¾ã‚Œã¦ã„ãªã„ â†’ **ãƒ–ãƒ­ãƒƒã‚¯**
6. å…¨ã¦ã®åŸºæº–ã‚’æº€ãŸã—ãŸå ´åˆ:
   - `stateManager.markTaskCompleted(task_id)` ã§ã‚¿ã‚¹ã‚¯ã‚’å®Œäº†ãƒãƒ¼ã‚¯
   - `stateManager.save()` ã§ session_state.yaml ã«ä¿å­˜
   - `{}` ã‚’è¿”ã—ã¦ã‚¿ã‚¹ã‚¯å®Œäº†ã‚’è¨±å¯

#### ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

- ãƒ•ãƒƒã‚¯å†…ã§ä¾‹å¤–ç™ºç”Ÿæ™‚ â†’ **ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒ—ãƒ³**ï¼ˆ`{}` ã‚’è¿”ã—ã¦ã‚¿ã‚¹ã‚¯å®Œäº†ã‚’è¨±å¯ï¼‰
- ãƒ­ã‚°å‡ºåŠ›: `console.error('TaskCompleted hook error:', error)`

#### è¿”ã‚Šå€¤

| æ¡ä»¶ | è¿”ã‚Šå€¤ | åŠ¹æœ |
|------|--------|------|
| å…¨ã¦ã®åŸºæº–ã‚’æº€ãŸã™ | `{}` | ã‚¿ã‚¹ã‚¯å®Œäº†ã‚’è¨±å¯ |
| åŸºæº–ä¸åˆæ ¼ | `{ decision: "block", reason: "..." }` | ã‚¿ã‚¹ã‚¯å®Œäº†ã‚’æ‹’å¦ï¼ˆexit code 2 ç›¸å½“ï¼‰ |
| ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ | `{}` | ã‚¿ã‚¹ã‚¯å®Œäº†ã‚’è¨±å¯ï¼ˆãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒ—ãƒ³ï¼‰ |

---

### 2.2 TeammateIdle Hook

**ãƒˆãƒªã‚¬ãƒ¼**: å”åŠ›ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒã‚¢ã‚¤ãƒ‰ãƒ«çŠ¶æ…‹ã«ãªã£ãŸã¨ã

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `scripts/monitor/hooks/teammate_idle.ts`

#### å‹•ä½œãƒ•ãƒ­ãƒ¼

1. å…¥åŠ›ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ `teammate_id` ã‚’å–å¾—
2. `StateManager` çµŒç”±ã§è©²å½“ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®æœªå®Œäº†ã‚¿ã‚¹ã‚¯ä¸€è¦§ã‚’å–å¾—
3. æœªå®Œäº†ã‚¿ã‚¹ã‚¯ãŒå­˜åœ¨ã™ã‚‹å ´åˆ:
   - **ãƒ–ãƒ­ãƒƒã‚¯**ï¼ˆ`{ decision: "block", reason: "æœªå®Œäº†ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™: {ã‚¿ã‚¹ã‚¯ä¸€è¦§}" }` ã‚’è¿”ã™ï¼‰
4. æœªå®Œäº†ã‚¿ã‚¹ã‚¯ãŒå­˜åœ¨ã—ãªã„å ´åˆ:
   - `stateManager.incrementIdleCount(teammate_id)` ã§ã‚¢ã‚¤ãƒ‰ãƒ«ã‚«ã‚¦ãƒ³ãƒˆã‚’å¢—åŠ 
   - `stateManager.save()` ã§ session_state.yaml ã«ä¿å­˜
   - `{}` ã‚’è¿”ã—ã¦ã‚¢ã‚¤ãƒ‰ãƒ«çŠ¶æ…‹ã‚’è¨±å¯

#### ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

- ãƒ•ãƒƒã‚¯å†…ã§ä¾‹å¤–ç™ºç”Ÿæ™‚ â†’ **ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒ—ãƒ³**ï¼ˆ`{}` ã‚’è¿”ã—ã¦ã‚¢ã‚¤ãƒ‰ãƒ«çŠ¶æ…‹ã‚’è¨±å¯ï¼‰
- ãƒ­ã‚°å‡ºåŠ›: `console.error('TeammateIdle hook error:', error)`

#### è¿”ã‚Šå€¤

| æ¡ä»¶ | è¿”ã‚Šå€¤ | åŠ¹æœ |
|------|--------|------|
| æœªå®Œäº†ã‚¿ã‚¹ã‚¯ãªã— | `{}` | ã‚¢ã‚¤ãƒ‰ãƒ«çŠ¶æ…‹ã‚’è¨±å¯ |
| æœªå®Œäº†ã‚¿ã‚¹ã‚¯ã‚ã‚Š | `{ decision: "block", reason: "..." }` | ã‚¢ã‚¤ãƒ‰ãƒ«çŠ¶æ…‹ã‚’æ‹’å¦ |
| ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ | `{}` | ã‚¢ã‚¤ãƒ‰ãƒ«çŠ¶æ…‹ã‚’è¨±å¯ï¼ˆãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒ—ãƒ³ï¼‰ |

---

### 2.3 Stop Hook

**ãƒˆãƒªã‚¬ãƒ¼**: ã‚¿ãƒ¼ãƒ³çµ‚äº†æ™‚ï¼ˆå„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å‡¦ç†ãŒä¸€åŒºåˆ‡ã‚Šã¤ã„ãŸã¨ãï¼‰

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `scripts/monitor/hooks/stop_validator.ts`

#### å‹•ä½œãƒ•ãƒ­ãƒ¼

1. ç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢ãƒ•ãƒ©ã‚° `stopHookActive` ã‚’ãƒã‚§ãƒƒã‚¯
   - æ—¢ã« `true` ã®å ´åˆ â†’ `{}` ã‚’è¿”ã—ã¦å³åº§ã«çµ‚äº†
2. `stopHookActive = true` ã«è¨­å®š
3. `StateManager` ã‚’åˆæœŸåŒ–ã—ã¦ç¾åœ¨ã®çŠ¶æ…‹ã‚’èª­ã¿è¾¼ã¿
4. `stateManager.save()` ã§ session_state.yaml ã«æœ€æ–°çŠ¶æ…‹ã‚’ä¿å­˜
5. `stopHookActive = false` ã«ãƒªã‚»ãƒƒãƒˆï¼ˆfinally ãƒ–ãƒ­ãƒƒã‚¯ã§ä¿è¨¼ï¼‰

#### ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

- ãƒ•ãƒƒã‚¯å†…ã§ä¾‹å¤–ç™ºç”Ÿæ™‚ â†’ ãƒ­ã‚°å‡ºåŠ›ã—ã¦ `{}` ã‚’è¿”ã™
- ãƒ­ã‚°å‡ºåŠ›: `console.error('StopValidator hook error:', error)`
- `stopHookActive` ã¯ finally ãƒ–ãƒ­ãƒƒã‚¯ã§å¿…ãš `false` ã«ãƒªã‚»ãƒƒãƒˆ

#### è¿”ã‚Šå€¤

å¸¸ã« `{}` ã‚’è¿”ã™ï¼ˆãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ãªã—ï¼‰

---

### 2.4 PostToolUse Hook

**ãƒˆãƒªã‚¬ãƒ¼**: ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ãŸå¾Œï¼ˆéãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ã€async: trueï¼‰

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `scripts/monitor/hooks/audit_logger.ts`

#### å‹•ä½œãƒ•ãƒ­ãƒ¼

1. å…¥åŠ›ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ `tool_name`, `tool_input`, `tool_output`, `timestamp` ã‚’å–å¾—
2. ãƒ­ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª `logs/monitor` ã‚’ä½œæˆï¼ˆå­˜åœ¨ã—ãªã„å ´åˆï¼‰
3. ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç”Ÿæˆ: `audit_{YYYYMMDD}.jsonl`ï¼ˆæ—¥ä»˜ãƒ™ãƒ¼ã‚¹ï¼‰
4. ãƒ­ã‚°ã‚¨ãƒ³ãƒˆãƒªã‚’ JSON Lines å½¢å¼ã§è¿½è¨˜:
   ```json
   {"timestamp":"2026-02-16T01:23:45.678Z","tool_name":"...","tool_input":{...},"tool_output":{...}}
   ```

#### ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

- ãƒ•ãƒƒã‚¯å†…ã§ä¾‹å¤–ç™ºç”Ÿæ™‚ â†’ ãƒ­ã‚°å‡ºåŠ›ã—ã¦ `{}` ã‚’è¿”ã™
- ãƒ­ã‚°å‡ºåŠ›: `console.error('AuditLogger hook error:', error)`

#### è¿”ã‚Šå€¤

å¸¸ã« `{}` ã‚’è¿”ã™ï¼ˆãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ãªã—ï¼‰

#### éãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°è¨­å®š

start.ts ã§ä»¥ä¸‹ã®ã‚ˆã†ã«è¨­å®š:

```typescript
PostToolUse: {
  async: true,
  handler: async (input: any) => await hooks.PostToolUse(input),
}
```

`async: true` ã«ã‚ˆã‚Šã€ãƒ„ãƒ¼ãƒ«ä½¿ç”¨ã®å®Œäº†ã‚’å¾…ãŸãšã«ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå‡¦ç†ãŒç¶™ç¶šã•ã‚Œã‚‹ã€‚

---

## 3. session_state.yaml ã®ã‚¹ã‚­ãƒ¼ãƒå®šç¾©ã¨æ›´æ–°ãƒ­ã‚¸ãƒƒã‚¯

### ã‚¹ã‚­ãƒ¼ãƒå®šç¾©

```yaml
teammates:
  - id: string              # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆè­˜åˆ¥å­ï¼ˆä¾‹: "teammate1", "teammate2"ï¼‰
    tasks: string[]         # ç¾åœ¨å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ã„ã‚‹ã‚¿ã‚¹ã‚¯ ID ã®ãƒªã‚¹ãƒˆ
    idle_count: number      # ã‚¢ã‚¤ãƒ‰ãƒ«çŠ¶æ…‹ã«ãªã£ãŸç´¯ç©å›æ•°
```

### åˆæœŸçŠ¶æ…‹

```yaml
teammates: []
```

### æ›´æ–°ãƒ­ã‚¸ãƒƒã‚¯

#### 3.1 ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰ã®è‡ªå‹•æ›´æ–°ï¼ˆupdateFromMessageï¼‰

`onMessage` ã§å—ä¿¡ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã® `type` ã«å¿œã˜ã¦è‡ªå‹•æ›´æ–°:

| ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¿ã‚¤ãƒ— | å‹•ä½œ |
|-----------------|------|
| `task_assigned` | `teammate.tasks` ã« `task_id` ã‚’è¿½åŠ ï¼ˆé‡è¤‡å›é¿ï¼‰ |
| `task_completed` | `teammate.tasks` ã‹ã‚‰ `task_id` ã‚’å‰Šé™¤ |
| `idle` | `teammate.idle_count` ã‚’ +1 |

ãƒ†ãƒ¼ãƒ ãƒ¡ã‚¤ãƒˆãŒå­˜åœ¨ã—ãªã„å ´åˆã¯è‡ªå‹•ä½œæˆ: `{ id, tasks: [], idle_count: 0 }`

#### 3.2 ã‚¿ã‚¹ã‚¯å®Œäº†ãƒãƒ¼ã‚¯ï¼ˆmarkTaskCompletedï¼‰

å…¨ã¦ã®ãƒ†ãƒ¼ãƒ ãƒ¡ã‚¤ãƒˆã® `tasks` ãƒªã‚¹ãƒˆã‹ã‚‰è©²å½“ `task_id` ã‚’å‰Šé™¤ã€‚

#### 3.3 æœªå®Œäº†ã‚¿ã‚¹ã‚¯å–å¾—ï¼ˆgetPendingTasksForï¼‰

æŒ‡å®šã•ã‚ŒãŸ `teammate_id` ã® `tasks` ãƒªã‚¹ãƒˆã‚’è¿”ã™ã€‚

#### 3.4 ã‚¢ã‚¤ãƒ‰ãƒ«ã‚«ã‚¦ãƒ³ãƒˆå¢—åŠ ï¼ˆincrementIdleCountï¼‰

æŒ‡å®šã•ã‚ŒãŸ `teammate_id` ã® `idle_count` ã‚’ +1ã€‚ãƒ†ãƒ¼ãƒ ãƒ¡ã‚¤ãƒˆãŒå­˜åœ¨ã—ãªã„å ´åˆã¯è‡ªå‹•ä½œæˆã€‚

#### 3.5 å—å…¥åŸºæº–å–å¾—ï¼ˆgetAcceptanceCriteriaï¼‰

1. `queue/tasks/*.yaml` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èµ°æŸ»
2. `task.task_id` ãŒä¸€è‡´ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç™ºè¦‹ã—ãŸã‚‰:
   - `task.acceptance_criteria` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå­˜åœ¨ â†’ ãã®ã¾ã¾è¿”ã™ï¼ˆé…åˆ—åŒ–ï¼‰
   - `task.description` ã‹ã‚‰ `- [ ]` ã¾ãŸã¯ `- [x]` å½¢å¼ã®è¡Œã‚’æŠ½å‡º â†’ é…åˆ—ã§è¿”ã™
3. è©²å½“ãªã—ã®å ´åˆã¯ç©ºé…åˆ—ã‚’è¿”ã™

---

## 4. éšœå®³æ¤œçŸ¥ã®é–¾å€¤ã¨åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯

### ç¾åœ¨ã®å®Ÿè£…çŠ¶æ…‹

**éšœå®³æ¤œçŸ¥ã®é–¾å€¤ã¯æœªå®Ÿè£…**ã€‚å°†æ¥ã®æ‹¡å¼µãƒã‚¤ãƒ³ãƒˆ:

- `idle_count` ãŒé–¾å€¤ã‚’è¶…ãˆãŸå ´åˆã®è­¦å‘Š
- ã‚¿ã‚¹ã‚¯å®Œäº†ç‡ã®ä½ä¸‹æ¤œçŸ¥
- ã‚³ã‚¹ãƒˆè¶…éã‚¢ãƒ©ãƒ¼ãƒˆ

### åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ï¼ˆäºˆå®šï¼‰

ä»¥ä¸‹ã¯å°†æ¥å®Ÿè£…æ™‚ã®è¨­è¨ˆæ¡ˆ:

| æŒ‡æ¨™ | é–¾å€¤ | åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ |
|------|------|-------------|
| ã‚¢ã‚¤ãƒ‰ãƒ«å›æ•° | 5å›ä»¥ä¸Š | `teammate.idle_count >= 5` â†’ è­¦å‘Š |
| ã‚¿ã‚¹ã‚¯æ»ç•™æ™‚é–“ | 30åˆ†ä»¥ä¸Š | `Date.now() - task_assigned_timestamp > 30 * 60 * 1000` â†’ è­¦å‘Š |
| ã‚³ã‚¹ãƒˆè¶…é | $10.00/ã‚»ãƒƒã‚·ãƒ§ãƒ³ | `costTracker.totalCostUsd > 10.0` â†’ è­¦å‘Š |

---

## 5. ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒ—ãƒ³æ–¹é‡

### åŸºæœ¬æ–¹é‡

**ãƒ•ãƒƒã‚¯è‡ªä½“ã®éšœå®³æ™‚ã¯ã‚¿ã‚¹ã‚¯å®Œäº†ã‚’è¨±å¯ã™ã‚‹**

ã™ã¹ã¦ã®ãƒ•ãƒƒã‚¯ã¯ä»¥ä¸‹ã®åŸå‰‡ã«å¾“ã†:

1. **ä¾‹å¤–ã¯ catch ã™ã‚‹**: try-catch ã§å…¨å‡¦ç†ã‚’ãƒ©ãƒƒãƒ—
2. **ã‚¨ãƒ©ãƒ¼æ™‚ã¯ç©ºã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿”ã™**: `return {}` â†’ ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ãªã—
3. **ãƒ­ã‚°å‡ºåŠ›**: `console.error()` ã§ã‚¨ãƒ©ãƒ¼å†…å®¹ã‚’è¨˜éŒ²

### å…·ä½“çš„ãªé©ç”¨ç®‡æ‰€

| ãƒ•ãƒƒã‚¯ | ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒ—ãƒ³å®Ÿè£… |
|--------|---------------------|
| TaskCompleted | - `task_id` æœªå®šç¾©æ™‚<br>- å—å…¥åŸºæº–ãŒå­˜åœ¨ã—ãªã„æ™‚<br>- ä¾‹å¤–ç™ºç”Ÿæ™‚ |
| TeammateIdle | - ä¾‹å¤–ç™ºç”Ÿæ™‚ |
| Stop | - ä¾‹å¤–ç™ºç”Ÿæ™‚ |
| PostToolUse | - ä¾‹å¤–ç™ºç”Ÿæ™‚ |

### è¨­è¨ˆç†ç”±

- **å¯ç”¨æ€§å„ªå…ˆ**: ãƒ•ãƒƒã‚¯éšœå®³ã§ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå…¨ä½“ãŒåœæ­¢ã™ã‚‹ãƒªã‚¹ã‚¯ã‚’å›é¿
- **ãƒ‡ãƒãƒƒã‚°å®¹æ˜“æ€§**: ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’æ®‹ã—ã¤ã¤ã€å‡¦ç†ã¯ç¶™ç¶š
- **é‹ç”¨å®‰å®šæ€§**: åˆæœŸå°å…¥æ™‚ã®æœªçŸ¥ã®éšœå®³ã«å¯¾ã™ã‚‹è€æ€§

---

## 6. ã‚³ã‚¹ãƒˆè¿½è·¡: onMessage â†’ cost_tracker ã®æµã‚Œ

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
Agent SDK query()
  â†“
onMessage ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
  â†“
costTracker.track(msg)
  â†“
CostTracker ã‚¯ãƒ©ã‚¹ï¼ˆãƒ¡ãƒ¢ãƒªå†…ã§ç´¯ç©ï¼‰
  â†“
ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†æ™‚: costTracker.writeTo()
  â†“
logs/monitor/cost_summary.json
```

### CostTracker ã‚¯ãƒ©ã‚¹ã®å‹•ä½œ

#### track(msg) ãƒ¡ã‚½ãƒƒãƒ‰

ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰ä»¥ä¸‹ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æŠ½å‡ºã—ã¦ç´¯ç©:

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | èª¬æ˜ |
|-----------|------|
| `msg.total_cost_usd` | ã‚¿ãƒ¼ãƒ³ã”ã¨ã®ã‚³ã‚¹ãƒˆï¼ˆUSDï¼‰ |
| `msg.duration_ms` | ã‚¿ãƒ¼ãƒ³ã”ã¨ã®å‡¦ç†æ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰ |
| `numTurns` | ã‚¿ãƒ¼ãƒ³æ•°ï¼ˆtrack å‘¼ã³å‡ºã—å›æ•°ï¼‰ |

#### getSummary() ãƒ¡ã‚½ãƒƒãƒ‰

ç¾åœ¨ã®ç´¯è¨ˆã‚³ã‚¹ãƒˆæƒ…å ±ã‚’è¿”ã™:

```typescript
{
  totalCostUsd: number,       // ç´¯è¨ˆã‚³ã‚¹ãƒˆï¼ˆUSDï¼‰
  totalDurationMs: number,    // ç´¯è¨ˆå‡¦ç†æ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰
  numTurns: number,           // ã‚¿ãƒ¼ãƒ³æ•°
  avgCostPerTurn: number      // ã‚¿ãƒ¼ãƒ³å¹³å‡ã‚³ã‚¹ãƒˆï¼ˆtotalCostUsd / numTurnsï¼‰
}
```

#### writeTo(path) ãƒ¡ã‚½ãƒƒãƒ‰

ã‚µãƒãƒªã‚’ JSON ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦æ›¸ãå‡ºã—:

```json
{
  "totalCostUsd": 0.0123,
  "totalDurationMs": 4567,
  "numTurns": 3,
  "avgCostPerTurn": 0.0041
}
```

### start.ts ã§ã®çµ±åˆ

```typescript
const costTracker = new CostTracker();

await query({
  // ...
  onMessage: (msg: any) => {
    costTracker.track(msg);           // ã‚³ã‚¹ãƒˆè¿½è·¡
    stateManager.updateFromMessage(msg); // çŠ¶æ…‹æ›´æ–°
    console.log(`ğŸ’¬ Message from ${msg.from || 'agent'}: ${msg.type || 'unknown type'}`);
  },
});

console.log('ğŸ“Š Cost summary:', costTracker.getSummary());
await costTracker.writeTo('logs/monitor/cost_summary.json');
```

---

## 7. dry-run ãƒ¢ãƒ¼ãƒ‰

### ç›®çš„

è¨­å®šæ¤œè¨¼ã®ã¿ã‚’è¡Œã„ã€Agent SDK ã® `query()` ã‚’å‘¼ã°ãšã«çµ‚äº†ã™ã‚‹ã€‚

### èµ·å‹•æ–¹æ³•

```bash
node start.ts --dry-run
```

### å‹•ä½œãƒ•ãƒ­ãƒ¼

1. ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°ã‹ã‚‰ `--dry-run` ãƒ•ãƒ©ã‚°ã‚’æ¤œå‡º: `process.argv.includes('--dry-run')`
2. ä»¥ä¸‹ã®åˆæœŸåŒ–ã‚’å®Ÿè¡Œ:
   - `config/settings.yaml` èª­ã¿è¾¼ã¿
   - `StateManager` åˆæœŸåŒ– + `session_state.yaml` èª­ã¿è¾¼ã¿
   - `instructions/battalion_commander.md` èª­ã¿è¾¼ã¿
   - hooks ç™»éŒ²
3. è¨­å®šæ¤œè¨¼æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡ºåŠ›:
   ```
   âœ… Dry-run mode: Configuration loaded successfully. Exiting without starting agent.
   ```
4. `process.exit(0)` ã§çµ‚äº†

### ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã‚‹å‡¦ç†

- `CostTracker` åˆæœŸåŒ–
- Agent SDK ã®å‹•çš„ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
- `query()` èµ·å‹•
- `onMessage` ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
- `stateManager.save()` / `costTracker.writeTo()`

### æ¤œè¨¼ã•ã‚Œã‚‹é …ç›®

- [ ] `config/settings.yaml` ã®å­˜åœ¨ã¨ `agent_teams` ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å¦¥å½“æ€§
- [ ] `session_state.yaml` ã®èª­ã¿è¾¼ã¿å¯èƒ½æ€§
- [ ] `instructions/battalion_commander.md` ã®å­˜åœ¨ã¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º
- [ ] hooks ã®ç™»éŒ²å¯èƒ½æ€§

### ä½¿ç”¨ä¾‹

CI/CD ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã§ã®è¨­å®šæ¤œè¨¼:

```bash
cd scripts/monitor
npm install
node start.ts --dry-run || exit 1
```

---

## ã¾ã¨ã‚

ã“ã®ãƒ¢ãƒ‹ã‚¿ãƒ—ãƒ­ã‚»ã‚¹ã¯ä»¥ä¸‹ã®ç‰¹æ€§ã‚’æŒã¤:

- **é«˜å¯ç”¨æ€§**: ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒ—ãƒ³æ–¹é‡ã«ã‚ˆã‚Šã€ãƒ•ãƒƒã‚¯éšœå®³ã§ã‚‚å‡¦ç†ã‚’ç¶™ç¶š
- **çŠ¶æ…‹æ°¸ç¶šåŒ–**: session_state.yaml ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’ä¿å­˜ã—ã€å¾©å¸°ãƒ¢ãƒ¼ãƒ‰ã‚’ã‚µãƒãƒ¼ãƒˆ
- **ç›£æŸ»å¯èƒ½**: PostToolUse ãƒ•ãƒƒã‚¯ã§å…¨ãƒ„ãƒ¼ãƒ«ä½¿ç”¨ã‚’ JSON Lines å½¢å¼ã§ãƒ­ã‚°è¨˜éŒ²
- **ã‚³ã‚¹ãƒˆè¿½è·¡**: CostTracker ã§ç´¯è¨ˆã‚³ã‚¹ãƒˆãƒ»ã‚¿ãƒ¼ãƒ³æ•°ãƒ»å¹³å‡ã‚³ã‚¹ãƒˆã‚’è¨˜éŒ²
- **æ¤œè¨¼å¯èƒ½**: dry-run ãƒ¢ãƒ¼ãƒ‰ã§è¨­å®šã®å¦¥å½“æ€§ã‚’äº‹å‰ç¢ºèª
- **å“è³ªä¿è¨¼**: TaskCompleted ãƒ•ãƒƒã‚¯ã§å—å…¥åŸºæº–ã‚’è‡ªå‹•æ¤œè¨¼

